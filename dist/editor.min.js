!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).Eeditor=t()}(this,function(){"use strict";var u=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},t=function(){function n(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),e}}(),c=function(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)};function n(e){for(var t=Object.create(null),i=e.split(","),n=0;n<i.length;n++)t[i[n]]=!0;return function(e){return t[e]}}function d(e){var t=parseInt(e);return t==t?t:0}function h(){for(var e=arguments.length,t=Array(e),i=0;i<e;i++)t[i]=arguments[i];return t=t.filter(function(e){return"number"==typeof e&&e==e}),Math.max.apply(Math,c(t))}function e(){}function r(e,t){"function"==typeof e&&(t?e.call(t):e())}function v(e){if("string"!=typeof e)return e;var t,i=document.querySelector(e);return i||(t="Cannot find element: "+e,console.error(t),document.createElement("div"))}function f(e){var t=document.createElement("div");return e?0<=e.indexOf("<")?(t.innerHTML=e,t.children[0]):document.createElement(e):t}function p(e,t){var i=window.getComputedStyle(e)[t]||"";return n("width,height,top,left,right,bottom")(t)?d(i):i}function i(e,t){e.classList.add(t)}function a(e,t){e.classList.remove(t)}function w(e,t,i,n){if("string"==typeof e)(e=v(e)).addEventListener(t,i),n&&(e["$"+t]=new Event(t));else if(e instanceof NodeList||e instanceof HTMLCollection)for(var o=0;o<e.length;o++)e[o].addEventListener(t,i),n&&(e[o]["$"+t]=new Event(t));else e.addEventListener(t,i),n&&(e["$"+t]=new Event(t))}function m(e,t,i){"string"==typeof e&&(e=v(e)),e.removeEventListener(t,i)}function o(e,t){var i,n,o,r,a,l,u,s=t.el=v(e.el);t.tools=(i=e.tools)?(n=i.split(" "),o=new Set(n),[].concat(c(o))):[];a=s,l=(r=e).width||p(a,"width"),u=r.height||p(a,"height"),r.width=h(l,600),r.height=h(u,400),e.styleWith=e.styleWith||"css",t.options=e}function s(e,t,i){document.execCommand(e,!1,t),i&&i()}function y(e,t){return document.queryCommandState(e)}var l=function(){function o(e){u(this,o),this._active=!1,this._editor=e;var t=this._uid="bold-"+e._uid,i=this.el=f('<div class="ee-tool ee-tool-bold"></div>'),n=this.main=f('<div id="'+t+'" class="ee-tool-normal bold-button eticon-bold"></div>');i.appendChild(n),function(e){var t=e.main,i=e._editor._s;if(!t)return;w(t,"click",function(){i.restoreSelection(),e.do()})}(this)}return t(o,[{key:"query",value:function(){var e=y("bold");this._active=!!e,this._active?i(this.main,"et-active"):a(this.main,"et-active")}},{key:"do",value:function(){var e=this;s("bold",null,function(){e.query(),e._editor._s.saveRange()})}},{key:"cancel",value:function(){this._active&&this.do()}}]),o}();var g=function(){function o(e){u(this,o),this._active=!1,this._editor=e;var t=this._uid="italic-"+e._uid,i=this.el=f('<div class="ee-tool ee-tool-italic"></div>'),n=this.main=f('<div id="'+t+'" class="ee-tool-normal italic-button eticon-italic"></div>');i.appendChild(n),function(e){var t=e.main,i=e._editor._s;if(!t)return;w(t,"click",function(){i.restoreSelection(),e.do()})}(this)}return t(o,[{key:"query",value:function(){var e=y("italic");this._active=!!e,this._active?i(this.main,"et-active"):a(this.main,"et-active")}},{key:"do",value:function(){var e=this;s("italic",null,function(){e.query.call(e),e._editor._s.saveRange()})}},{key:"cancel",value:function(){this._active&&this.do()}}]),o}();var _=function(){function o(e){u(this,o),this._active=!1,this._editor=e;var t=this._uid="lineThrough-"+e._uid,i=this.el=f('<div class="ee-tool ee-tool-lineThrough"></div>'),n=this.main=f('<div id="'+t+'" class="ee-tool-normal lineThrough-button eticon-lineThrough"></div>');i.appendChild(n),function(e){var t=e.main,i=e._editor._s;if(!t)return;w(t,"click",function(){i.restoreSelection(),e.do()})}(this)}return t(o,[{key:"query",value:function(){var e=y("strikeThrough");this._active=!!e,this._active?i(this.main,"et-active"):a(this.main,"et-active")}},{key:"do",value:function(){var e=this;s("strikeThrough",null,function(){e.query.call(e),e._editor._s.saveRange()})}},{key:"cancel",value:function(){this._active&&this.do()}}]),o}();var b=0,C={el:"body",hex:"#ff0000",mask:!1,hsvpStyle:{width:200,height:150},hStyle:{width:200,height:15},afterColorChange:e,afterShow:e,beforeHide:e,autoClose:!0},k=function(){function o(e){var t,i;u(this,o),this.id=b++,this.option=(t=C,i=e,Object.assign(t,i));var n=e.el;this.el="string"==typeof n?v(n):n,function(e){var t=e.wrap=f('<div id="ew-cp-'+e.id+'" class="ew-cp"></div>'),i=(s=e,c=s.option.hsvpStyle,a=s._back=f('<div id="ew-hsvp-'+s.id+'" style="width:'+c.width+"px;height:"+c.height+'px" class="ew-hsvp"><div class="ew-hsvp-m1"></div><div class="ew-hsvp-m2"></div></div>'),h=s._hsvCusor=f('<span class="ew-hsvc"></span>'),a.appendChild(h),w(a,"mousedown",function e(t){t.preventDefault();var i=a.getBoundingClientRect(),n=i.left,o=i.top,l=t.pageX-n-6,u=t.pageY-o-6;function r(){m("body","mousemove",e),m("body","mouseup",r)}l<-6&&(l=-6),l>c.width-6&&(l=c.width-6),u<-6&&(u=-6),u>c.height-6&&(u=c.height-6),setTimeout(function(){h.style.top=u+"px",h.style.left=l+"px";var e=s._hsv.s=(l+6)/c.width,t=s._hsv.v=1-(u+6)/c.height,i=A(s._hsv.h,e,t),n="rgb("+i.r+","+i.g+","+i.b+")";s._preview.style.backgroundColor=n;var o=s._rInput.value=i.r,r=s._gInput.value=i.g,a=s._bInput.value=i.b;s._hexInput.value=I(o,r,a)},10),w("body","mousemove",e),w("body","mouseup",r),s.afterColorChange()}),a);var s,c,a,h;t.appendChild(i);var n=(p=e,y=p.option.hStyle,g=f('<div id="ew-hp-'+p.id+'" style="width:'+y.width+"px;height:"+y.height+'px" class="ew-hp"></div>'),_=p._hCursor=f('<span class="ew-hpc"></span>'),g.appendChild(_),w(g,"mousedown",function e(t){t.preventDefault();var i=g.getBoundingClientRect(),n=i.left,o=t.pageX-n-2;o<-2&&(o=-2),o>y.width-2&&(o=y.width-2);var r=p._hsv,a=r.h=(o+2)/y.width,l=A(a,1,1),u="rgb("+l.r+","+l.g+","+l.b+")";p._back&&(p._back.style.backgroundColor=u),_.style.left=o+"px";var s=A(a,r.s,r.v),c=s.r,h=s.g,d=s.b,v=I(c,h,d);function f(){m("body","mousemove",e),m("body","mouseup",f)}p._hexInput.value=v,p._rInput.value=c,p._gInput.value=h,p._bInput.value=d,p._preview.style.backgroundColor="#"+v,p.afterColorChange(),w("body","mousemove",e),w("body","mouseup",f)}),g);var p,y,g,_;t.appendChild(n);var o=function(s){var e=f('<div class="ew-cip"></div>'),t=f('<div class="ew-cip-row1 ew-cip-row"><div class="ew-cip-row-sub">R:<input value=255 class="ew-cip-i"></div><div class="ew-cip-row-sub">G:<input value=0 class="ew-cip-i"></div><div class="ew-cip-row-sub">B:<input value=0 class="ew-cip-i"></div></div>');e.appendChild(t);var i=t.querySelectorAll(".ew-cip-i"),n=(s._rInput=i[0],s._gInput=i[1],s._bInput=i[2],f('<div class="ew-cip-row2 ew-cip-row"><div class="ew-cip-row-sub">HEX:#<input value="FF0000" maxlength=6 class="ew-cip-hex"></div><div class="ew-cip-row-sub ew-cip-pre"></div></div>')),o=s._hexInput=n.querySelector(".ew-cip-hex"),c=s._preview=n.querySelector(".ew-cip-pre");return s._preview=n.querySelector(".ew-cip-pre"),e.appendChild(n),w(o,"blur",function(){var e,t,i,n,o=this.value=function(e){if(6<=(e=e.replace(/[^A-Z|^a-z|^0-9]/g,"")).length)e=e.substring(0,6);else if(3===e.length)e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2];else for(var t=e.length;t<6;t++)e+="0";return e}(this.value).toUpperCase(),r=(e=o,t=parseInt(e.substr(0,2),16),i=parseInt(e.substr(2,2),16),n=parseInt(e.substr(4,2),16),{r:t,g:i,b:n}),a=s._hsv=q(r.r,r.g,r.b);x(a.h,s),S(a,s);var l=A(a.h,1,1),u="rgb("+l.r+","+l.g+","+l.b+")";s._back&&(s._back.style.backgroundColor=u),c.style.backgroundColor="#"+o,s.afterColorChange()},!0),w(i,"blur",function(){var e=this.value.replace(/[^0-9]/g,"");e=d(e),this.value=255<e?255:e<0?0:e;var t=s._rInput.value,i=s._gInput.value,n=s._bInput.value,o=I(t,i,n);s._hexInput.value=o,s._preview.style.backgroundColor="#"+o;var r=s._hsv=q(t,i,n);x(r.h,s),S(r,s),s.afterColorChange()},!0),e}(e);t.appendChild(o),e.el.appendChild(t)}(this),this._hsv={h:0,s:1,v:1}}return t(o,[{key:"show",value:function(){if(this.wrap&&this.option.autoClose){var e=this;n=this.wrap,o=function(){e.beforeHide()},w(document.body,"click",function e(t){var i=t.target;n===i||n.contains(i)||(r(o),n.style.display="none",m(document.body,"click",e))})}var n,o;this.wrap&&(this.wrap.style.display="block"),this.afterShow()}},{key:"hide",value:function(){this.beforeHide(),this.wrap&&(this.wrap.style.display="none")}},{key:"hsv",value:function(){return this._hsv}},{key:"rgb",value:function(){return{r:this._rInput.value,g:this._gInput.value,b:this._bInput.value}}},{key:"hex",value:function(){return this._hexInput.value}},{key:"setHex",value:function(e){this._hexInput.value=e,this._hexInput.dispatchEvent(this._hexInput.$blur)}},{key:"afterColorChange",value:function(){var e=this.option.afterColorChange;r(e,this)}},{key:"afterShow",value:function(){var e=this.option.afterShow;r(e,this)}},{key:"beforeHide",value:function(){var e=this.option.beforeHide;r(e,this)}}]),o}();function S(e,t){var i=t.option.hsvpStyle,n=e.s*i.width-6,o=(1-e.v)*i.height-6,r=t._hsvCusor;r&&(r.style.top=o+"px")&&(r.style.left=n+"px")}function x(e,t){var i=e*t.option.hStyle.width-2;t._hCursor&&(t._hCursor.style.left=i+"px")}function I(e,t,i){return 1==(e=e.toString(16)).length&&(e="0"+e),1==(t=t.toString(16)).length&&(t="0"+t),1==(i=i.toString(16)).length&&(i="0"+i),(e+t+i).toUpperCase()}function q(e,t,i){var n,o=h(e=d(e),t=d(t),i=d(i)),r=function(){for(var e=arguments.length,t=Array(e),i=0;i<e;i++)t[i]=arguments[i];return t=t.filter(function(e){return"number"==typeof e&&e==e}),Math.min.apply(Math,c(t))}(e,t,i),a=0,l=0,u=o-r;return 360<(a=o===r?0:e===o?i<=t?60*(t-i)/u:60*(t-i)/u+360:t===o?60*(i-e)/u+120:60*(e-t)/u+240)?a-=360:a<0&&(a+=360),l=u/o,n=o/255,{h:a/=360,s:l=isNaN(l)?0:l,v:n}}function A(e,t,i){e*=360;var n=0,o=0,r=0,a=Math.floor(e/60),l=e/60-a,u=i*(1-t),s=i*(1-l*t),c=i*(1-(1-l)*t);return n=i,o=c,r=u,0===a&&(n=i,o=c,r=u),1===a&&(n=s,o=i,r=u),2===a&&(n=u,o=i,r=c),3===a&&(n=u,o=s,r=i),4===a&&(n=c,o=u,r=i),5===a&&(n=i,o=u,r=s),{r:n=Math.round(255*n),g:o=Math.round(255*o),b:r=Math.round(255*r)}}var E=function(){function l(e){var t,i;u(this,l),this._value="#1A1A1A",this._editor=e,i={el:(t=this)._editor._wrap,beforeHide:function(){t._editor._s.restoreSelection();var e=this.hex();t.main.querySelector("span").style.backgroundColor="#"+e,s("foreColor",e),t._editor._s.saveRange()}},t._cp=new k(i);var n,o=this._uid="foreColor-"+e._uid,r=this.el=f('<div class="ee-tool ee-tool-foreColor"></div>'),a=this.main=f('<div id="'+o+'" class="ee-tool-normal foreColor-button eticon-color"><span></span></div>');r.appendChild(a),w((n=this).main,"click",function(e){e.stopPropagation(),e.cancelBubble=!0,n._cp.show()})}return t(l,[{key:"query",value:function(){var e;this._value=this.main.querySelector("span").style.backgroundColor=(e="foreColor",document.queryCommandValue(e))}}]),l}();var R=function(){function o(e){u(this,o),this._active=!1,this._editor=e;var t=this._uid="bold-"+e._uid,i=this.el=f('<div class="ee-tool ee-tool-underline"></div>'),n=this.main=f('<div id="'+t+'" class="ee-tool-normal underline-button eticon-underline"></div>');i.appendChild(n),function(e){var t=e.main,i=e._editor._s;if(!t)return;w(t,"click",function(){i.restoreSelection(),e.do()})}(this)}return t(o,[{key:"query",value:function(){var e=y("underline");this._active=!!e,this._active?i(this.main,"et-active"):a(this.main,"et-active")}},{key:"do",value:function(){var e=this;s("underline",null,function(){e.query(),e._editor._s.saveRange()})}},{key:"cancel",value:function(){this._active&&this.do()}}]),o}();var T=["1","2","3","4","5","6","7"],L=function(){function l(e){u(this,l),this._active=!1,this._editor=e;for(var t=this._uid="bold-"+e._uid,i=this.el=f('<div class="ee-tool ee-tool-fontSize"></div>'),n='<div id="'+t+'" class="ee-tool-normal fontSize-button eticon-fontSize"><select class="ew-selector ew-selector-fontsize">',o=0;o<T.length;o++){var r=T[o];n+='<option value="'+r+'">'+r+"</option>"}n+="</select></div>";var a=this.main=f(n);i.appendChild(a),function(e){var t=e.main,i=e._editor._s;if(!t)return;w(t,"click",function(){i.restoreSelection(),e.do()})}(this)}return t(l,[{key:"query",value:function(){var e=y("fontSize");this._active=!!e,this._active?i(this.main,"et-active"):a(this.main,"et-active")}},{key:"do",value:function(){var e=this;s("fontSize",null,function(){e.query(),e._editor._s.saveRange()})}},{key:"cancel",value:function(){this._active&&this.do()}}]),l}();var z={bold:function(e,t){var i=e.cmd.bold=new l(e);t.appendChild(i.el)},italic:function(e,t){var i=e.cmd.italic=new g(e);t.appendChild(i.el)},lineThrough:function(e,t){var i=e.cmd.lineThrough=new _(e);t.appendChild(i.el)},foreColor:function(e,t){var i=e.cmd.foreColor=new E(e);t.appendChild(i.el)},underline:function(e,t){var i=e.cmd.underline=new R(e);t.appendChild(i.el)},fontSize:function(e,t){var i=e.cmd.fontSize=new L(e);t.appendChild(i.el)}};n("bold,italic,underline,lineThrough,fontSize,foreColor,link,code,fontName,image,orderedList,unorderedList,center,full,left,right,redo,undo,hiliteColor");function H(e){var t=e.options,i=e._wrap=f('<div id="editor-'+e._uid+'" class="editor-wrap" style="width:'+t.width+"px;height:"+t.height+'px"></div>');!function(e){var t=e._wrap,i=f('<div class="editor-toolbar"></div>'),n=e.tools;console.log(n);for(var o=0;o<n.length;o++){var r=n[o],a=z[r];a&&a(e,i)}t.appendChild(i)}(e),function(u){var e=u._uid,t=u.options.height-46,i="ew-"+e,n=f('<div id="ew-container-'+e+'" class="ew-container"><div id="'+i+'" class="ew" contenteditable=true spellcheck=false style="height:'+t+'px"></div></div>'),o=n.querySelector("#"+i);function r(){u._s.saveRange()}w(o,"mouseup",r),w(o,"mouseup",function(){var e=u.cmd;if(e){var t=!0,i=!1,n=void 0;try{for(var o,r=Object.keys(e)[Symbol.iterator]();!(t=(o=r.next()).done);t=!0){var a=o.value,l=e[a];l.query&&l.query()}}catch(e){i=!0,n=e}finally{try{!t&&r.return&&r.return()}finally{if(i)throw n}}}}),w(o,"keyup",r),u._wrap.appendChild(n)}(e),e.el.appendChild(i)}var M=function(){function e(){u(this,e),this._sel=null,this._range=null}return t(e,[{key:"saveRange",value:function(e){if(e)return this._range=e;var t=this._sel=window.getSelection();if(!t.rangeCount)return this._range=null;e=t.getRangeAt(0);var i=this.getSelectionContainer(e);if(!i||"true"!==!i.getAttribute("contenteditable")&&!function e(t,i){var n=document.querySelectorAll(i);if(!n.length)return null;if("html"===t.nodeName.toLowerCase())return null;for(var o=0;o<n.length;o++)if(n[o]===t.parentNode||n[o]===t)return n[o];return e(t.parentNode,i)}(i,"[contenteditable=true]"))return this._range=null;this._range=e}},{key:"getSelectionContainer",value:function(e){if(!e)return null;var t=e.commonAncestorContainer;return 1===t.nodeType?t:t.parentNode}},{key:"restoreSelection",value:function(e){if(e=e||this._range){var t=window.getSelection();t.removeAllRanges(),t.addRange(e)}}},{key:"getSelectionContainerElem",value:function(e){var t=void 0;if(e=e||this._range)return 1===(t=e.commonAncestorContainer).nodeType?t:t.parentNode}},{key:"isSelectionEmpty",value:function(){var e=this._range;return!(!e||!e.startContainer||e.startContainer!==e.endContainer||e.startOffset!==e.endOffset)}},{key:"createRangeByElem",value:function(e){var t=document.createRange();t.selectNode(e),this.saveRange(t)}}]),e}();var N=0,O=function e(){u(this,e),this._uid=N++};return O.prototype.init=function(e){o(e,this),this._s=new M,this.cmd={},H(this),function t(i){s("styleWithCSS","css"===i.options.styleWith);var e=i._wrap.querySelector("#ew-"+i._uid);if(!e.children.length){var n=f("<p><br></p>");e.appendChild(n)}w(e,"keyup",function(e){8===e.keyCode&&t(i)})}(this)},O});
